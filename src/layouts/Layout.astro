---
import "../styles/global.css";
import "@fontsource/montserrat/400.css";
import "@fontsource/montserrat/700.css";

/** Page props (title/description remain optional; we auto-fill if omitted) */
export interface Props {
  title?: string;
  description?: string;
  lang?: "de" | "en" | "it";
}

const { title, description, lang = "de" } = Astro.props;

/** Derive the current page key from the path: home | imprint | privacy */
const path = Astro.url.pathname.toLowerCase();
function getPageKey(p: string): "home" | "imprint" | "privacy" {
  if (/(impressum|imprint)/.test(p)) return "imprint";
  if (/(datenschutz|privacy)/.test(p)) return "privacy";
  return "home";
}
const pageKey = getPageKey(path);

/** SEO strings per language & page */
const SEO = {
  de: {
    home: {
      title: "Steuerberatung | Meyer Tax – digital & mehrsprachig",
      desc:
        "Digitale Steuerberatung für Deutschland, Österreich, Schweiz und Italien. Mehrsprachig, transparent, sicher, papierlos. Bundesweit verfügbar. Jetzt Erstgespräch vereinbaren!"
    },
    imprint: {
      title: "Impressum & Kontakt | Meyer Tax Steuerberatung Leipzig",
      desc:
        "Rechtliche Angaben und Kontakt zu Meyer Tax Steuerberatung in Leipzig. Wirtschaftsprüfer Daniel Meyer, Aufsichtsbehörde, Impressum gemäß §5 TMG."
    },
    privacy: {
      title: "Datenschutzerklärung | Meyer Tax Steuerberatung Leipzig",
      desc:
        "Datenschutzerklärung von Meyer Tax Leipzig: Informationen zur Datenverarbeitung, Cookies, Ihre Rechte nach DSGVO und Datensicherheit."
    }
  },
  en: {
    home: {
      title: "Tax Consulting | Meyer Tax – digital & multilingual",
      desc:
        "Digital tax consulting for Germany, Austria, Switzerland, and Italy. Multilingual, transparent, secure, paperless. Available nationwide. Book your free consultation now!"
    },
    imprint: {
      title: "Imprint & Contact | Meyer Tax Tax Consulting Leipzig",
      desc:
        "Legal information and contact details for Meyer Tax in Leipzig. Auditor Daniel Meyer, supervisory authority, imprint according to German law."
    },
    privacy: {
      title: "Privacy Policy | Meyer Tax Tax Consulting Leipzig",
      desc:
        "Privacy policy of Meyer Tax Leipzig: Information on data processing, cookies, your rights under GDPR, and data security measures."
    }
  },
  it: {
    home: {
      title: "Consulenza fiscale | Meyer Tax – digitale e multilingue",
      desc:
        "Consulenza fiscale digitale per Germania, Austria, Svizzera e Italia. Multilingue, trasparente, sicura, senza carta. Disponibile in tutta la Germania. Prenota ora!"
    },
    imprint: {
      title: "Note legali & Contatto | Meyer Tax Consulenza fiscale Lipsia",
      desc:
        "Informazioni legali e contatto per Meyer Tax a Lipsia. Revisore Daniel Meyer, autorità di vigilanza, note legali secondo la legge tedesca."
    },
    privacy: {
      title: "Informativa privacy | Meyer Tax Consulenza fiscale Lipsia",
      desc:
        "Informativa sulla privacy di Meyer Tax Lipsia: Trattamento dati, cookie, diritti GDPR e misure di sicurezza dei dati personali."
    }
  }
} as const;

/** Final meta title/description with override capability via props */
const metaTitle = title ?? SEO[lang][pageKey].title;
const metaDescription = description ?? SEO[lang][pageKey].desc;

/** Meta keywords per language */
const metaKeywords = {
  de: "Steuerberatung, Steuerberater Leipzig, Wirtschaftsprüfer, digitale Steuerberatung, mehrsprachig, Deutschland, Österreich, Schweiz, Italien, Steuerberatung Leipzig, Unternehmensbewertung, Wirtschaftsprüfung",
  en: "tax consulting, tax consultant Leipzig, auditor, digital tax consulting, multilingual, Germany, Austria, Switzerland, Italy, Leipzig tax advisor, business valuation, audit",
  it: "consulenza fiscale, consulente fiscale Lipsia, revisore, consulenza fiscale digitale, multilingue, Germania, Austria, Svizzera, Italia, consulente fiscale Lipsia, valutazione aziendale"
} as const;

/** Locale mapping for Open Graph */
const ogLocaleByLang = { de: "de_DE", en: "en_US", it: "it_IT" } as const;

/** Canonical (safe for staging) */
const canonicalUrl = Astro.url.href;

/** Hreflang (staging-safe: same origin + language prefixes) */
const pathname = Astro.url.pathname;
const search = Astro.url.search ?? "";
const pathNoLang = (pathname.replace(/^\/(en|it)(?=\/|$)/, "") || "/") + search;
const origin = Astro.url.origin;

const alt = {
  de: `${origin}${pathNoLang}`,
  en: `${origin}/en${pathNoLang === "/" ? "/" : pathNoLang}`,
  it: `${origin}/it${pathNoLang === "/" ? "/" : pathNoLang}`
} as const;
const xDefault = alt.en;

/** Enhanced JSON-LD Structured Data */

// Organization & ProfessionalService & LocalBusiness
const orgJsonLd = {
  "@context": "https://schema.org",
  "@type": ["Organization", "ProfessionalService", "LocalBusiness", "FinancialService"],
  "@id": `${origin}/#organization`,
  name: "Meyer Tax",
  alternateName: "Daniel Meyer Tax Consulting",
  url: origin,
  email: "info@tax-meyer.de",
  telephone: "+49-341-23037176",
  address: {
    "@type": "PostalAddress",
    streetAddress: "Schulze-Boysen-Str. 2",
    postalCode: "04317",
    addressLocality: "Leipzig",
    addressRegion: "Sachsen",
    addressCountry: "DE"
  },
  geo: {
    "@type": "GeoCoordinates",
    latitude: 51.3397,
    longitude: 12.4027
  },
  logo: {
    "@type": "ImageObject",
    url: `${origin}/lm_logo.png`,
    width: 240,
    height: 240
  },
  image: `${origin}/og-image.jpg`,
  description: "Digitale, mehrsprachige Steuerberatung für Deutschland, Österreich, Schweiz und Italien. Digital multilingual tax consulting.",
  sameAs: ["https://www.linkedin.com/in/daniel-meyer-7bb221152/"],
  openingHoursSpecification: [
    {
      "@type": "OpeningHoursSpecification",
      dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
      opens: "09:00",
      closes: "19:00"
    }
  ],
  contactPoint: [
    {
      "@type": "ContactPoint",
      telephone: "+49-341-23037176",
      contactType: "customer service",
      availableLanguage: ["German", "English"],
      areaServed: ["DE", "AT", "CH"],
      contactOption: "TollFree",
      hoursAvailable: {
        "@type": "OpeningHoursSpecification",
        dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
        opens: "09:00",
        closes: "19:00"
      }
    },
    {
      "@type": "ContactPoint",
      telephone: "+49-341-23037177",
      contactType: "customer service",
      availableLanguage: ["Italian"],
      areaServed: ["IT"],
      contactOption: "TollFree",
      hoursAvailable: {
        "@type": "OpeningHoursSpecification",
        dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
        opens: "09:00",
        closes: "19:00"
      }
    }
  ],
  areaServed: [
    { "@type": "Country", "name": "Germany", "identifier": "DE" },
    { "@type": "Country", "name": "Austria", "identifier": "AT" },
    { "@type": "Country", "name": "Switzerland", "identifier": "CH" },
    { "@type": "Country", "name": "Italy", "identifier": "IT" }
  ],
  serviceType: ["Tax Consulting", "Steuerberatung", "Consulenza fiscale"],
  knowsLanguage: ["de", "en", "it"],
  priceRange: "$$",
  paymentAccepted: ["Cash", "Invoice", "Bank Transfer"],
  currenciesAccepted: "EUR"
};

// WebSite with SearchAction
const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": `${origin}/#website`,
  url: origin,
  name: "Meyer Tax",
  description: "Digitale, mehrsprachige Steuerberatung",
  publisher: {
    "@id": `${origin}/#organization`
  },
  inLanguage: ["de", "en", "it"]
};

// Person - Daniel Meyer
const personJsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": `${origin}/#person`,
  name: "Daniel Meyer",
  jobTitle: "Tax Consultant / Steuerberater",
  worksFor: {
    "@id": `${origin}/#organization`
  },
  sameAs: ["https://www.linkedin.com/in/daniel-meyer-7bb221152/"],
  knowsLanguage: ["de", "en", "it"]
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    <meta name="keywords" content={metaKeywords[lang]} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Search Console Verification -->
    <meta name="google-site-verification" content="HuR6l7tq-qBoGEcgMhzAzpS1l9GHCGGa5Oon5Ro2VCE" />

    <!-- Performance Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="/lm_logo.png" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#1e40af" />

    <!-- Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Hreflang -->
    <link rel="alternate" href={alt.de} hreflang="de" />
    <link rel="alternate" href={alt.en} hreflang="en" />
    <link rel="alternate" href={alt.it} hreflang="it" />
    <link rel="alternate" href={xDefault} hreflang="x-default" />

    <!-- Robots -->
    <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />

    <!-- Geo-targeting -->
    <meta name="geo.region" content="DE;AT;CH;IT" />
    <meta name="geo.placename" content="Germany;Austria;Switzerland;Italy" />
    <meta name="language" content={lang} />
    <meta name="author" content="Daniel Meyer" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Meyer Tax" />
    <meta property="og:locale" content={ogLocaleByLang[lang]} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={`${origin}/og-image.jpg?v=2`} />
    <meta property="og:image:secure_url" content={`${origin}/og-image.jpg?v=2`} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Meyer Tax – Steuerberatung · Tax Consulting · Consulenza fiscale" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={`${origin}/og-image.jpg?v=2`} />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" is:inline set:html={JSON.stringify(orgJsonLd)} />
    <script type="application/ld+json" is:inline set:html={JSON.stringify(websiteJsonLd)} />
    <script type="application/ld+json" is:inline set:html={JSON.stringify(personJsonLd)} />
  </head>
  <body class="font-sans bg-background">
    <slot />

    <!-- GoatCounter Analytics -->
    <script data-goatcounter="https://tax-meyer.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </body>
</html>
