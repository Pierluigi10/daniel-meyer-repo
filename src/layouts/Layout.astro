---
import "../styles/global.css";
import "@fontsource/montserrat/400.css";
import "@fontsource/montserrat/700.css";

/** Page props (title/description remain optional; we auto-fill if omitted) */
export interface Props {
  title?: string;
  description?: string;
  lang?: "de" | "en" | "it";
}

const { title, description, lang = "de" } = Astro.props;

/** Derive the current page key from the path: home | imprint | privacy */
const path = Astro.url.pathname.toLowerCase();
function getPageKey(p: string): "home" | "imprint" | "privacy" {
  if (/(impressum|imprint)/.test(p)) return "imprint";
  if (/(datenschutz|privacy)/.test(p)) return "privacy";
  return "home";
}
const pageKey = getPageKey(path);

/** SEO strings per language & page */
const SEO = {
  de: {
    home: {
      title: "Steuerberatung | Meyer Tax – digital & mehrsprachig",
      desc:
        "Digitale, mehrsprachige Steuerberatung. Transparent, sicher, papierlos. Jetzt kostenloses Erstgespräch vereinbaren."
    },
    imprint: {
      title: "Impressum | Meyer Tax",
      desc:
        "Rechtliche Angaben zu Meyer Tax – Verantwortliche, Kontakt und Unternehmensinformationen."
    },
    privacy: {
      title: "Datenschutzerklärung | Meyer Tax",
      desc:
        "Informationen zur Verarbeitung personenbezogener Daten, Cookies und Ihren Rechten."
    }
  },
  en: {
    home: {
      title: "Tax Consulting | Meyer Tax – digital & multilingual",
      desc:
        "Digital, multilingual tax consulting. Transparent, secure, paperless. Book a free initial consultation."
    },
    imprint: {
      title: "Imprint | Meyer Tax",
      desc:
        "Legal information about Meyer Tax – responsible entity, contact and company details."
    },
    privacy: {
      title: "Privacy Policy | Meyer Tax",
      desc:
        "Information about personal data processing, cookies and your rights."
    }
  },
  it: {
    home: {
      title: "Consulenza fiscale | Meyer Tax – digitale e multilingue",
      desc:
        "Consulenza fiscale digitale e multilingue. Trasparente, sicura, senza carta. Prenota una prima consulenza gratuita."
    },
    imprint: {
      title: "Note legali | Meyer Tax",
      desc:
        "Informazioni legali su Meyer Tax – responsabili, contatti e dati societari."
    },
    privacy: {
      title: "Informativa sulla privacy | Meyer Tax",
      desc:
        "Informazioni sul trattamento dei dati personali, sui cookie e sui tuoi diritti."
    }
  }
} as const;

/** Final meta title/description with override capability via props */
const metaTitle = title ?? SEO[lang][pageKey].title;
const metaDescription = description ?? SEO[lang][pageKey].desc;

/** Locale mapping for Open Graph */
const ogLocaleByLang = { de: "de_DE", en: "en_US", it: "it_IT" } as const;

/** Canonical (safe for staging) */
const canonicalUrl = Astro.url.href;

/** Hreflang (staging-safe: same origin + language prefixes) */
const pathname = Astro.url.pathname;
const search = Astro.url.search ?? "";
const pathNoLang = (pathname.replace(/^\/(en|it)(?=\/|$)/, "") || "/") + search;
const origin = Astro.url.origin;

const alt = {
  de: `${origin}${pathNoLang}`,
  en: `${origin}/en${pathNoLang === "/" ? "/" : pathNoLang}`,
  it: `${origin}/it${pathNoLang === "/" ? "/" : pathNoLang}`
} as const;
const xDefault = alt.en;

/** Enhanced JSON-LD Structured Data */

// Organization & ProfessionalService
const orgJsonLd = {
  "@context": "https://schema.org",
  "@type": ["Organization", "ProfessionalService"],
  "@id": `${origin}/#organization`,
  name: "Meyer Tax",
  alternateName: "Daniel Meyer Tax Consulting",
  url: origin,
  email: "info@tax-meyer.de",
  logo: {
    "@type": "ImageObject",
    url: `${origin}/lm_logo.png`,
    width: "192",
    height: "192"
  },
  image: `${origin}/og-image.jpg`,
  description: "Digitale, mehrsprachige Steuerberatung für Deutschland, Österreich, Schweiz und Italien. Digital multilingual tax consulting.",
  sameAs: ["https://www.linkedin.com/in/daniel-meyer-7bb221152/"],
  areaServed: [
    { "@type": "Country", "name": "Germany" },
    { "@type": "Country", "name": "Austria" },
    { "@type": "Country", "name": "Switzerland" },
    { "@type": "Country", "name": "Italy" }
  ],
  serviceType: ["Tax Consulting", "Steuerberatung", "Consulenza fiscale"],
  knowsLanguage: ["de", "en", "it"],
  priceRange: "$$"
};

// WebSite with SearchAction
const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": `${origin}/#website`,
  url: origin,
  name: "Meyer Tax",
  description: "Digitale, mehrsprachige Steuerberatung",
  publisher: {
    "@id": `${origin}/#organization`
  },
  inLanguage: ["de", "en", "it"]
};

// Person - Daniel Meyer
const personJsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": `${origin}/#person`,
  name: "Daniel Meyer",
  jobTitle: "Tax Consultant / Steuerberater",
  worksFor: {
    "@id": `${origin}/#organization`
  },
  sameAs: ["https://www.linkedin.com/in/daniel-meyer-7bb221152/"],
  knowsLanguage: ["de", "en", "it"]
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Performance Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="/lm_logo.png" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#1e40af" />

    <!-- Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Hreflang -->
    <link rel="alternate" href={alt.de} hreflang="de" />
    <link rel="alternate" href={alt.en} hreflang="en" />
    <link rel="alternate" href={alt.it} hreflang="it" />
    <link rel="alternate" href={xDefault} hreflang="x-default" />

    <!-- Robots -->
    <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />

    <!-- Geo-targeting -->
    <meta name="geo.region" content="DE;AT;CH;IT" />
    <meta name="geo.placename" content="Germany;Austria;Switzerland;Italy" />
    <meta name="language" content={lang} />
    <meta name="author" content="Daniel Meyer" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Meyer Tax" />
    <meta property="og:locale" content={ogLocaleByLang[lang]} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={`${origin}/og-image.jpg?v=2`} />
    <meta property="og:image:secure_url" content={`${origin}/og-image.jpg?v=2`} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Meyer Tax – Steuerberatung · Tax Consulting · Consulenza fiscale" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={`${origin}/og-image.jpg?v=2`} />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" is:inline set:html={JSON.stringify(orgJsonLd)} />
    <script type="application/ld+json" is:inline set:html={JSON.stringify(websiteJsonLd)} />
    <script type="application/ld+json" is:inline set:html={JSON.stringify(personJsonLd)} />
  </head>
  <body class="font-sans bg-background">
    <slot />
  </body>
</html>
